#!/bin/bash

set -e

echo -e "\n-------------------------------------------------------------------------------------------\n"
date

set -x

cd "$(dirname "$0")"
templates_dir="/usr/local/bin/templates"
test_repo=/tmp/test-repo
last_build="$HOME/.last_build"

rm -rf $test_repo
cd ../../ # we're in repo root

# copy the repo over to a temp directory and switch to it
rsync -ax --exclude site-builder/target . $test_repo
cd $test_repo
token=$(cat ./.token)
ip_token=$(cat ./.ip_token)
git reset --hard
# git checkout bot-publish
git checkout gh-pages
git fetch
git reset --hard origin/gh-pages

# run the binary
GH_TOKEN=$token IP_API_TOKEN=$ip_token site-builder --template-file-path="$templates_dir/index.html" --out-file-path="$test_repo/index.html"
tailwindcss --content "$test_repo/*.html" -c "$templates_dir/tailwind.config.js" -i "$templates_dir/tw.css" -o "$test_repo/style.css"

# new file generated by binary
new="$test_repo/index.html"

if cmp --silent "$last_build" "$new"; then
    set +x
    echo "files are the same, no need to publish"
    echo -e "\n-------------------------------------------------------------------------------------------\n"
    exit 0
fi

set +x
echo "files differ, publishing"
set -x
publish_date=$(date)
git add "$test_repo/index.html" "$test_repo/style.css"
git commit -m "Bot publish: $publish_date"
git push

cp "$new" "$last_build"

set +x
echo -e "\n-------------------------------------------------------------------------------------------\n"
